#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

if [ "$ENFORCE_PREPUSH" != "1" ]; then
  echo "‚è≠Ô∏è  Skipping pre-push checks (set ENFORCE_PREPUSH=1 to enable)"
  exit 0
fi

echo "üîé Running pre-push checks (ENFORCE_PREPUSH=1)..."

# Build (fail fast if prod build breaks)
npm run build || exit 1

# Lint (if configured)
npm run lint || exit 1

# Unit tests
node --test tests/unit/*.test.cjs || exit 1

# Smoke E2E (fast) ‚Äî allow bypass for flaky CI via PREPUSH_SKIP_SMOKE=1
if [ "$PREPUSH_SKIP_SMOKE" = "1" ]; then
  echo "‚è≠Ô∏è  Skipping smoke E2E (PREPUSH_SKIP_SMOKE=1)"
else
  npx playwright test -g @smoke --project=chromium || exit 1
fi

# Critical memory check (first-turn + 4-turn continuity)
npx playwright test tests/memory.spec.ts -g "TC-MEM-000" --project=chromium || exit 1

echo "‚úÖ Pre-push checks passed"
